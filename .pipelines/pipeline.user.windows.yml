environment:
  host:
    os: 'windows'
    flavor: 'server'
    version: '2019'
  runtime:
    provider: 'appcontainer'
    image: 'cdpxwin1809.azurecr.io/global/vse2019:latest'
    source_mode: 'map'
signing_options:
  profile: '170'
restore:
  commands:
    - !!defaultcommand
      name: 'Download collectd-api.jar'
      command: '.scripts/downloadCollectdJar.cmd'
    - !!defaultcommand
      name: 'Install Windows 8.1 SDK'
      command: '.scripts/installWindows81SDK.cmd'
      logs:
        - from: 'AIJ-BuildLogs/Restore/WinSdk'
          to: 'Build Logs/Restore/WinSdk'
          include:
            - '**/*.log'
    - !!defaultcommand
      name: 'Install Java 11 JDK'
      command: '.scripts/installJava11jdk.cmd'
    - !!defaultcommand
      name: 'Install Java 7 JRE'
      command: '.scripts/installJava7jre.cmd'
    - !!defaultcommand
      name: 'Clean and Resolve Dependencies'
      command: '.scripts/gradle.cmd'
      arguments: 'clean resolveDependencies --info --stacktrace --refresh-dependencies'
build:
  commands:
    - !!buildcommand
      name: 'Assemble Perf Counters DLL'
      command: './scripts/gradle.cmd'
      arguments: ':core:windowsX64SharedLibrary :core:windowsX86SharedLibrary --info --stacktrace'
      artifacts:
        - from: 'core/build/libs/windows/shared'
          include:
            - '**/*.dll'
          signing_options:
            profile: external_distribution
    - !!buildcommand
      name: 'Assemble ApplicationInsights-Java JARs'
      command: '.scripts/gradle.cmd'
      arguments: 'assemble --info --stacktrace'
      artifacts:
        - to: 'Artifacts'
          include:
            - '**/build/libs/*.jar'
    - !!defaultcommand
      name: 'Checks for ApplicationInsights-Java'
      command: '.scripts/gradle.cmd'
      arguments: 'check --info --stacktrace -x test'
      logs:
        - to: 'Checks Reports'
          include:
            - '**/build/reports/**/*'
          exclude:
            - '**/build/reports/tests/**/*'
    - !!testcommand
      name: 'Run ApplicationInsights-Java Unit Tests'
      command: '.scripts/gradle.cmd'
      arguments: 'test --info --stacktrace'
      fail_on_stderr: false
      testresults:
        - title: ':core Unit Test Results'
          type: 'junit'
          include:
            - 'core/build/test-results/test/*.xml'
        - title: ':agent Unit Test Results'
          type: 'junit'
          include:
            - 'agent/build/test-results/test/*.xml'
        - title: ':ApplciationInsightsInternalLogger Unit Test Results'
          type: 'junit'
          include:
            - 'ApplciationInsightsInternalLogger/build/test-results/test/*.xml'
        - title: ':azure-application-insights-spring-boot-starter Unit Test Results'
          type: 'junit'
          include:
            - 'azure-application-insights-spring-boot-starter/build/test-results/test/*.xml'
        - title: ':web Unit Test Results'
          type: 'junit'
          include:
            - 'web/build/test-results/test/*.xml'
        - title: ':web-auto Unit Test Results'
          type: 'junit'
          include:
            - 'web-auto/build/test-results/test/*.xml'
        - title: ':logging:common Unit Test Results'
          type: 'junit'
          include:
            - 'logging/common/build/test-results/test/*.xml'
        - title: ':logging:log4j1_2 Unit Test Results'
          type: 'junit'
          include:
            - 'logging/log4j1_2/build/test-results/test/*.xml'
        - title: ':logging:log4j2 Unit Test Results'
          type: 'junit'
          include:
            - 'logging/log4j2/build/test-results/test/*.xml'
        - title: ':logging:logback Unit Test Results'
          type: 'junit'
          include:
            - 'logging/logback/build/test-results/test/*.xml'
      logs:
        - to: 'Test Logs'
          include:
            - '**/build/reports/tests/**/*'
